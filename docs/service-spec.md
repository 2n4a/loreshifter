# Терминология

- Мир (world) - то, что создает автор - шаблон для игры.
- Игра (game) - конкретная игра, созданная из существующего мира.
- Комната (room) - игра, в контексте ожидания игроков.
- Игрок (player) - человек, играющий в игре.
- Хост (host) - игрок, который создает игру, или который получает привелегии человека, создавшего игру.
- Advice - сообщение в чате с наводящими вопросами.

# Бизнес-логика

## Создание аккаунта

Авторизация происходит с помощью OAuth2, токен хранится в cookie `session`.
Если при заходе на сервис в базе данных нет пользователя с таким email, то создается новый аккаунт.

## Создание мира

Мир создается автором. Внутри, мир полностью описывается одним json-объектом
неструктурированной природы, ограничений на него в базе данных нет.

Интерфейс и взаимодействие с этим объектом не специфицируется здесь.

Некоторые миры могут быть опубликованными для всех пользователей, другие могут быть
доступны только автору. Автор выбирает, опубликовать мир, или нет.

Опубликованные миры отображаются в списке миров пользователя на главной странице,
и из них можно создать игру. Также игру можно создать из приватного мира автору этого мира.

## Устройство чата

В игре активно используются чаты для различных целей.

Каждый чат представляет собой список сообщений, отправленных игроками, системой, или ИИ.
Примеры чатов:
1. Чат комнаты - общий чат с сообщениями от игроков в этой комнате.
2. Чат создания персонажей - чат, в котором игрок общается с ИИ, и получает от ИИ созданного персонажа.
3. Чат игры - чат, в котором игрок общается с ИИ, и описывает совершаемые в игре действия.
4. Чат адвайсов - чат, в котором игрок общается с ИИ, и задает наводящие вопросы для ИИ.

У каждого чата разная структура.

У некоторых чатов (2, 3, 4) есть владелец - единственный игрок, который может писать в чат.
Владелец не меняется после создания чата.

В общем случае чат - это список сообщений. Так как отправлять весь чат может быть дорого,
чат отправляется сегментами, или отдельными сообщениями. Каждый сегмент содержит id сообщений 
до него, список сообщений в сегменте, и id сообшения сразу после сегмента, а также информацию о чате.

Таким образом клиент может запрашивать сегменты из чата, и постепенно пополнять чат сообщениями
по мере необходимости (а может просто прочитать последние, и не подгружать ничего выше).

Чаты имеют свой id, который дается только при получении первого сегмента чата.

У каждого чата может быть список предложений для сообщения в этом чате.
Список генерируется ИИ, и игроку достаточно выбрать опцию с ответом.

У чата есть "интерфейс" - это способ взаимодействия чата с пользователем.
В какие-то чаты (например, в 2 между ходами), игрок не может писать сообщения. В этом
случае интерфейс является readonly.

В какие-то чаты игрок не может писать, потому что он чужой. В этом случае чат является foreign.

В какие-то чаты игрок может писать только в одно сообщение за время хода.
В этом случае чат является timed. Если игрок не пишет сообщение в течение времени,
его сообщение генерируется автоматически.

Чат 1 является full - в него может писать любой.

Как это заметно, интерфейсы чатов разные для разных игроков.

## Создание игры

Игры создаются игроками. Игрок, создавший игру, становится хостом.

Хост имеет права изменять настройки игры, а также выгонять игроков из игры, и
передать свои привелегии хоста другому игроку.

Любая игра проходит состояния waiting -> playing -> finished -> archived.

(Если все игроки вышли до состояния finished и не перезаходят, игра досрочно переходит в состояние archived.)

Игрок считается "вышедшим" при разрыве websocket соединения больше нескольких секунд.

## Игра в waiting

Пока игра в режиме ожидания, в нее могут заходить игроки.

Игра может быть приватной или публичной. У любой игры есть код - уникальная строка,
идентифицирующая игру, пока она не переходит в состояние archived.
По этой строке игроки могут присоединиться к игре, даже если она приватная.
К публичной игре можно присоединиться по id.

**Игрок не может быть присоединен к игре, если он уже в другой игре!**
Таким образом между игроками и играми отношение one-to-at-most-one.

Во время ожидания игроки могут писать в чаты игры и в чат создания персонажей.

Создание персонажа происходит в отдельном чате, в котором игрок общается с ИИ,
и получает от ИИ созданного персонажа. Как только ИИ создал персонажа, и игрок
его оценил, он может пометить себя как готовым.

Как только все игроки готовы, или хост принудительно начинает игру, игра становится playing.
Если игрок не успел создать персонажа к началу игры, персонаж создается автоматически.

## Игра в playing

Как только игра начинается, для каждого игрока создается чат игры и чат адвайсов.

В чате игры игрок может писать сообщения в одно сообщение за ход. До начала первого хода,
пока ИИ генерирует дополнительную информацию о мире и персонажах, чат находится в readonly.

Как только начинается ход, чат игрока становится timed. Если игрок не пишет сообщение в течение времени,
его сообщение генерируется автоматически. Желательно предлагать suggestion для сообщения.

Чужие чаты тем временем находятся в состояниях foreign, или foreign-timed.

Чат с адвайсами тем временем находится в full (для игрока) или в foreign (для других игроков).
После отправки сообщения в чат с адвайсами, ИИ генерирует ответ, и временно чат переходит в readonly.

Между ходами ИИ генерирует сообщения в чате игры, и принимает решения по поводу происходящего в игре.

Как только ИИ решает, что игра закончится, игра переходит в состояние finished.

Состояние чата комнаты в эту стадию не меняется и остается full - хотя показывать ли это во фронте - вопрос.

## Игра в finished

Игра в finished похожа на игру в waiting - игроки снова могут общаться в чате комнаты,
но теперь у хоста есть опция перезапустить игру. В этом случае создается новая игра в состоянии waiting,
которая является копией предыдущей игры (те же параметры, чаты сброшены, игроки не меняются, персонажи не удаляются (?)).

## Игра в archived

Как только все игроки выходят из игры и не переподключаются в течение настраивоемого времеми (30 секунд по умолчанию),
вне зависимости от состояния игры, игра переходит в состояние archived.
